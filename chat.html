<html>

<head>

  <title>Chat</title>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
  <link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
  <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.nicescroll/3.6.8-fix/jquery.nicescroll.min.js"></script>
</head>

<body>

  <div class="content container-fluid bootstrap snippets">
    <div class="row row-broken">
      <div class="col-sm-12 col-xs-12 chat" style="overflow: hidden; outline: none;" tabindex="5001">
        <div class="col-inside-lg decor-default">
          <div class="chat-body">
            <div id="chat-messages"></div>
            <div class="answer-add">
                <input type="text" id="msg" placeholder="digite sua mensagem">
                <button onclick="enviarMensagem();" class="btn btn-success">Enviar</button>
              <span class="answer-btn answer-btn-2"></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- <ul id="msgs"></ul> -->
  <!-- <input type="text" id="msg" placeholder="digite sua mensagem"> -->
  

  <script>
    localStorage.setItem('data', 0);
    function gerarId() {
      function id() {
        return Math.floor((1 + Math.random()) * 0x100000).toString(16).substring(1);
      }
      return id() + "-" + id() + "-" + id() + "-" + id() + "-" + id();
    }
    var idgerada = gerarId();
    localStorage.setItem('minhaid', idgerada);

    function enviarMensagem() {

      let result = document.querySelector('.result');
      let name = document.querySelector('#password');
      let email = document.querySelector('#email');
      let xhr = new XMLHttpRequest();
      let url = "/cliente/mensagens/enviar/";

      xhr.open("POST", url, true);
      xhr.setRequestHeader("Content-Type", "application/json");

      xhr.onreadystatechange = function () {
        let resp = this.responseText;
        if (xhr.readyState === 4 && xhr.status === 200) {

        } else {

        }
      };

      var data = JSON.stringify(
        {
          "usuarioId": idgerada,
          "msg": document.getElementById('msg').value,
          "timestamp": new Date().toLocaleString()
        }
      );
      xhr.send(data);
    }
    function mensagem(msg) {
      $(".chat").niceScroll();

      var chatmessages = [];

      console.log(chatmessages)
      chatmessages.push(msg)

      let htmldiv = ``;

      jQuery.each(chatmessages, function (i, item) {
        console.log(item);
        let position = item.username == 'outrousuario' ? 'left' : 'right';
        let ago = item.ago;
        htmldiv += `<div class="answer ${position}">
                <div class="avatar">
                  <img src="${item.avatar}" alt="${item.name}">
                  <div class="status offline"></div>
                </div>
                <div class="name">${item.name}</div>
                <div class="text">
                  ${item.text}
                </div>
                <div class="time">${ago}</div>
              </div>`;
      });

     // console.log(htmldiv);
      $("div#chat-messages").html(htmldiv);
      $(".chat").niceScroll();
    }



    function buscarDados() {

      $.ajax({
        url: "/cliente/mensagens/checar/",
        type: "GET",
        success: function (data) {

          if (data.length > localStorage.getItem('data')) {

            localStorage.setItem('data', data.length);
            localStorage.setItem('ultima', data.slice(-1).pop()._id);

            if (data.slice(-1).pop()._id == localStorage.getItem('ultima'))
              if (data.slice(-1).pop().usuarioId == localStorage.getItem('minhaid')) {
                var msg = {
                  username: data.slice(-1).pop().usuarioId,
                  name: "Eu",
                  avatar: 'https://bootdey.com/img/Content/avatar/avatar1.png',
                  text: data.slice(-1).pop().msg,
                  ago: data.slice(-1).pop().timestamp
                };

                mensagem(msg);

                $('#msgs').append($('<li id="exposta" style="background-color:green;">').text("üôã‚Äç‚ôÇÔ∏è eu disse :" + data.slice(-1).pop().msg));

            var msg = {
              username: 'eu',
              name: "Eu",
              avatar: 'https://bootdey.com/img/Content/avatar/avatar1.png',
              text: data.slice(-1).pop().msg,
              ago: data.slice(-1).pop().timestamp
            };

            mensagem(msg);
              } else {
                $('#msgs').append($('<li id="exposta" style="background-color:red;">').text(" üôã‚Äç‚ôÇÔ∏è outro usuario disse :" + data.slice(-1).pop().msg));

            var msg = {
              username: 'outrousuario',
              name: "outrousuario",
              avatar: 'https://bootdey.com/img/Content/avatar/avatar1.png',
              text: data.slice(-1).pop().msg,
              ago: data.slice(-1).pop().timestamp
            };

            mensagem(msg);

              }

          } else {


            console.log("sem novas mensagens")
          }

        },
        dataType: "json",
        complete: setTimeout(function () { buscarDados() }, 5000),
        timeout: 2000
      });
    }


    window.addEventListener('load', function () {
      buscarDados()
    });

  </script>
  <script src="/js/chat.js"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
    crossorigin="anonymous">
  <link rel="stylesheet" href="/css/chat.css">
</body>

</html>